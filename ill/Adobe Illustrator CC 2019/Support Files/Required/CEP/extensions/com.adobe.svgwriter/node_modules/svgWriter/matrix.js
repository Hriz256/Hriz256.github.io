!function(){"use strict";var t=require("./utils.js"),b=Math.asin,c=Math.sin,k=Math.cos,e=Math.tan,g=Math.atan2,y=Math.PI/180,T=180/Math.PI,P=t.round2,n=t.roundP;module.exports=new function(){function M(t,i){var r,s=0,n=t.length;for(r=0;r<n;r+=1)s+=t[r]*i[r];return s}function d(t){var i,r=0,s=t.length;for(i=0;i<s;i+=1)r+=t[i]*t[i];return Math.sqrt(r)}function A(t){var i,r=t.length,s=d(t),n=[];for(n.length=r,0===s&&(s=1),i=0;i<r;i+=1)n[i]=t[i]/s;return n}function x(t,i,r,s){var n=new Array(3);return n[0]=r*t[0]+s*i[0],n[1]=r*t[1]+s*i[1],n[2]=r*t[2]+s*i[2],n}function S(t){var i,r;if(this.identity=function(){var t,i;for(t=0;t<4;t+=1){for(this[t]=new Array(4),i=0;i<4;i+=1)this[t][i]=0;this[t][t]=1}return this},t)if("object"==typeof t&&"number"==typeof t.a&&"number"==typeof t.b&&"number"==typeof t.c&&"number"==typeof t.d&&"number"==typeof t.tx&&"number"==typeof t.ty)this.identity(),this[0][0]=t.a,this[0][1]=t.b,this[1][0]=t.c,this[1][1]=t.d,this[3][0]=t.tx||0,this[3][1]=t.ty||0;else for(i=0;i<4;i+=1)for(this[i]=new Array(4),r=0;r<4;r+=1)this[i][r]=t[i][r];else this.identity();this.isIdentity=function(){return!(1!=this[0][0]||this[0][1]||this[0][2]||this[0][3]||this[1][0]||1!=this[1][1]||this[1][2]||this[1][3]||this[2][0]||this[2][1]||1!=this[2][2]||this[2][3]||this[3][0]||this[3][1]||this[3][2]||1!=this[3][3])},this.determinant=function(){var t=this[0][0],i=this[0][1],r=this[0][2],s=this[0][3],n=this[1][0],e=this[1][1],h=this[1][2],a=this[1][3],o=this[2][0],u=this[2][1],f=this[2][2],l=this[2][3],c=this[3][0],y=this[3][1],w=this[3][2],p=this[3][3];return s*h*u*c-r*a*u*c-s*e*f*c+i*a*f*c+r*e*l*c-i*h*l*c-s*h*o*y+r*a*o*y+s*n*f*y-t*a*f*y-r*n*l*y+t*h*l*y+s*e*o*w-i*a*o*w-s*n*u*w+t*a*u*w+i*n*l*w-t*e*l*w-r*e*o*p+i*h*o*p+r*n*u*p-t*h*u*p-i*n*f*p+t*e*f*p},this.normalizeTransform=function(){if(0===this[3][3])return!1;var t,i;for(t=0;t<4;t+=1)for(i=0;i<4;i+=1)this[t][i]/=this[3][3];return!0},this.transpose=function(){var t,i,r=new S;for(t=0;t<4;t+=1)for(i=0;i<4;i+=1)r[t][i]=this[i][t];return r},this.rightMultiply=function(t){for(var i=new Array(4),r=0;r<4;r++)for(var s=i[r]=0;s<4;s++)i[r]+=t[s]*this[s][r];return i},this.transformPoint=function(t){var i=t[0],r=t[1];return(t=[])[0]=this[0][0]*i+this[1][0]*r+this[3][0],t[1]=this[0][1]*i+this[1][1]*r+this[3][1],t},this.transformPoints=function(t){var i;for(i=0;i<t.length;i++)t[i]=this.transformPoint(t[i]);return t},this.inverse=function(){var t=this[0][0],i=this[0][1],r=this[0][2],s=this[0][3],n=this[1][0],e=this[1][1],h=this[1][2],a=this[1][3],o=this[2][0],u=this[2][1],f=this[2][2],l=this[2][3],c=this[3][0],y=this[3][1],w=this[3][2],p=this[3][3],m=n*u-e*o,v=n*f-h*o,M=n*y-e*c,d=n*p-a*c,A=e*f-h*u,x=e*p-a*y,b=h*p-a*w,k=o*y-u*c,g=o*w-f*c,T=o*p-l*c,P=u*w-f*y,B=u*p-l*y,q=f*p-l*w,j=e*q-h*B+a*P,F=n*q-h*T+a*g,I=n*B-e*T+a*k,z=n*P-e*g+h*k,D=i*q-r*B+s*P,R=t*q-r*T+s*g,X=t*B-i*T+s*k,Y=t*P-i*g+r*k,Z=i*b-r*x+s*(e*w-h*y),O=t*b-r*d+s*(n*w-h*c),C=t*x-i*d+s*M,E=t*x-i*d+s*M,G=i*(h*w-a*f)-r*(e*w-a*u)+s*A,H=t*(h*l-a*f)-r*(n*l-a*o)+s*v,J=t*(e*p-a*u)-i*(n*p-a*o)+s*m,K=t*A-i*v+r*m;D=-D,X=-X,O=-O,E=-E,G=-G,J=-J;var L=t*j+i*(F=-F)+r*I+s*(z=-z);if(0!==L){var N=new S,Q=1/L;return N[0][0]=j*Q,N[0][1]=D*Q,N[0][2]=Z*Q,N[0][3]=G*Q,N[1][0]=F*Q,N[1][1]=R*Q,N[1][2]=O*Q,N[1][3]=H*Q,N[2][0]=I*Q,N[2][1]=X*Q,N[2][2]=C*Q,N[2][3]=J*Q,N[3][0]=z*Q,N[3][1]=Y*Q,N[3][2]=E*Q,N[3][3]=K*Q,N}},this.rotate3d=function(t,i,r,s,n){var e,h,a,o,u,f,l=new S;return n||(s*=y),s&&(o=t,u=i,f=r,0!==(a=Math.sqrt(o*o+u*u+f*f))&&(t/=a,i/=a,r/=a,e=c(s),h=k(s),l[0][0]=1+(1-h)*(t*t-1),l[1][0]=-r*e+(1-h)*t*i,l[2][0]=i*e+(1-h)*t*r,l[3][0]=0,l[0][1]=r*e+(1-h)*t*i,l[1][1]=1+(1-h)*(i*i-1),l[2][1]=-t*e+(1-h)*i*r,l[3][1]=0,l[0][2]=-i*e+(1-h)*t*r,l[1][2]=t*e+(1-h)*i*r,l[2][2]=1+(1-h)*(r*r-1),l[3][2]=0,l[0][3]=0,l[1][3]=0,l[2][3]=0,l[3][3]=1)),this.preMultiplyBy(l)},this.rotateX=function(t){return this.rotate3d(1,0,0,t)},this.rotateY=function(t){return this.rotate3d(0,1,0,t)},this.rotateZ=function(t){return this.rotate3d(0,0,1,t)},this.translate3d=function(t,i,r){var s=new S;return s[3][0]+=t,s[3][1]+=i,s[3][2]+=r,this.preMultiplyBy(s)},this.scale=function(t,i,r){if(1!=t||1!=i||1!=r){var s=new S;return s[0][0]=t,s[1][1]=i,s[2][2]=r,this.preMultiplyBy(s)}return this},this.skew=function(t,i,r){var s,n;return r||(t*=y,i*=y),0!==t&&((s=new S)[1][0]=e(t),this.preMultiplyBy(s)),0!==i&&((n=new S)[0][1]=e(i),this.preMultiplyBy(n)),this},this.preMultiplyBy=function(t){var i=t[0][0],r=t[0][1],s=t[0][2],n=t[0][3],e=t[1][0],h=t[1][1],a=t[1][2],o=t[1][3],u=t[2][0],f=t[2][1],l=t[2][2],c=t[2][3],y=t[3][0],w=t[3][1],p=t[3][2],m=t[3][3],v=this[0][0],M=this[0][1],d=this[0][2],A=this[0][3],x=this[1][0],b=this[1][1],k=this[1][2],g=this[1][3],T=this[2][0],P=this[2][1],B=this[2][2],q=this[2][3],j=this[3][0],F=this[3][1],I=this[3][2],z=this[3][3];return this[0][0]=i*v+r*x+s*T+n*j,this[0][1]=i*M+r*b+s*P+n*F,this[0][2]=i*d+r*k+s*B+n*I,this[0][3]=i*A+r*g+s*q+n*z,this[1][0]=e*v+h*x+a*T+o*j,this[1][1]=e*M+h*b+a*P+o*F,this[1][2]=e*d+h*k+a*B+o*I,this[1][3]=e*A+h*g+a*q+o*z,this[2][0]=u*v+f*x+l*T+c*j,this[2][1]=u*M+f*b+l*P+c*F,this[2][2]=u*d+f*k+l*B+c*I,this[2][3]=u*A+f*g+l*q+c*z,this[3][0]=y*v+w*x+p*T+m*j,this[3][1]=y*M+w*b+p*P+m*F,this[3][2]=y*d+w*k+p*B+m*I,this[3][3]=y*A+w*g+p*q+m*z,this}}this.matrixFromPoints=function(t,i){var r,s,n,e,h,a,o,u,f;function l(t,i){var r=t[0]-i[0],s=t[1]-i[1];return Math.sqrt(r*r+s*s)}function c(t,i){var r=i[0]-t[0],s=i[1]-t[1];return 0===s?0:P(T*Math.atan(s/r))}r=l(t[0],t[1]),s=l(t[0],t[3]),h=(n=l(i[0],i[1]))/r,a=(e=l(i[0],i[3]))/s,o=c(t[0],t[1]),u=c(i[0],i[1])-o,f=(f=new S).rotateZ(u);var y=r*h,w=s*a,p=(r-n)/2,m=(s-e)/2,v=t[0][0]+p,M=t[0][1]+m;return{matrix:f,bounds:[[v,M],[v+y,M],[v+y,M+w],[v,M+w]]}},this.containsOnlyTranslate=function(t){return 1===t[0][0]&&0===t[0][1]&&0===t[1][0]&&1===t[1][1]},this.createMatrix=function(t){return new S(t)},this.decomposeTransform=function(t){var i,r,s,n,e,h,a,o,u,f,l,c,y,w,p,m,v=new S(t);if(i=new S(t),!v.normalizeTransform())return null;for(r=0;r<3;r+=1)i[r][3]=0;if(i[3][3]=1,0===i.determinant(i))return null;if(s=new Array(4),n=new Array(4),0!==v[0][3]||0!==v[1][3]||0!==v[2][3]){if(s[0]=v[0][3],s[1]=v[1][3],s[2]=v[2][3],s[3]=v[3][3],!(e=i.inverse()))return!1;n=e.transpose().rightMultiply(s),v[0][3]=v[1][3]=v[2][3]=0,v[3][3]=1}else n[0]=n[1]=n[2]=0,n[3]=1;for((h=new Array(3))[0]=v[3][0],v[3][0]=0,h[1]=v[3][1],v[3][1]=0,h[2]=v[3][2],v[3][2]=0,(a=new Array(3))[0]=new Array(3),a[1]=new Array(3),a[2]=new Array(3),o=0;o<3;o+=1)a[o][0]=v[o][0],a[o][1]=v[o][1],a[o][2]=v[o][2];if((u=new Array(3))[0]=d(a[0]),a[0]=A(a[0]),(f=new Array(3))[0]=M(a[0],a[1]),a[1]=x(a[1],a[0],1,-f[0]),u[1]=d(a[1]),a[1]=A(a[1]),0!==u[1]&&(f[0]/=u[1]),f[1]=M(a[0],a[2]),a[2]=x(a[2],a[0],1,-f[1]),f[2]=M(a[1],a[2]),a[2]=x(a[2],a[1],1,-f[2]),u[2]=d(a[2]),0!==u[2]&&(a[2]=A(a[2])),0!==u[2]&&(f[1]/=u[2],f[2]/=u[2]),w=a[1],p=a[2],m=new Array(3),l=3!==w.length||3!==p.length?null:(m[0]=w[1]*p[2]-w[2]*p[1],m[1]=w[2]*p[0]-w[0]*p[2],m[2]=w[0]*p[1]-w[1]*p[0],m),M(a[0],l)<0)for(c=0;c<3;c+=1)u[c]*=-1,a[c][0]*=-1,a[c][1]*=-1,a[c][2]*=-1;return(y=new Array(3))[1]=b(-a[0][2]),0!==k(y[1])?(y[0]=g(a[1][2],a[2][2]),y[2]=g(a[0][1],a[0][0])):(y[0]=g(-a[2][0],a[1][1]),y[2]=0),{translation:h,rotation:y,scale:u,skew:f,perspective:n}},this.writeTransform=function(t,i,r,s){var n=this.decomposeTransform(t);return n.translation[2]||n.rotation[0]||n.rotation[1]||n.skew[0]||n.skew[1]||1!==P(n.scale[2])?this.writeRawMatrix(t,i,r,s):(n.translation[0]+=i,n.translation[1]+=r,this.writeDecomposedTransform(n,s))},this.writeRawMatrix=function(t,i,r,s){return s=isFinite(s)?Math.max(2,s):2,"number"==typeof t.a?"matrix("+n(t.a,s)+", "+n(t.b,s)+", "+n(t.c,s)+", "+n(t.d,s)+", "+n(t.tx+i,s)+", "+n(t.ty+r,s)+")":"matrix("+n(t[0][0],s)+", "+n(t[0][1],s)+", "+n(t[1][0],s)+", "+n(t[1][1],s)+", "+n(t[3][0]+i,s)+", "+n(t[3][1]+r,s)+")"},this.writeDecomposedTransform=function(t,i){var r=[],s="";return i=isFinite(i)?i:2,(t.translation[0]||t.translation[1])&&(t.translation[1]?r.push(s+"translate("+n(t.translation[0],i)+" "+n(t.translation[1],i)+")"):r.push(s+"translate("+n(t.translation[0],i)+")"),s=" "),P(T*t.rotation[2])&&(r.push(s+"rotate("+n(T*t.rotation[2],i)+")"),s=" "),P(T*t.skew[0])&&(r.push(s+"skewX("+n(T*t.skew[0],i)+")"),s=" "),P(T*t.skew[1])&&(r.push(s+"skewY("+n(T*t.skew[1],i)+")"),s=" "),1===P(t.scale[0])&&1===P(t.scale[1])||(i=Math.max(2,i),t.scale[0]!==t.scale[1]?r.push(s+"scale("+n(t.scale[0],i)+" "+n(t.scale[1],i)+")"):r.push(s+"scale("+n(t.scale[0],i)+")"),s=" "),r.join("")}}}();