!function(){"use strict";var b=require("./svgStylesheet.js"),v=require("./svgWriterStroke.js"),M=require("./svgWriterFill.js"),C=require("./svgWriterFx.js"),O=require("./svgWriterMask.js"),N=require("./svgWriterClipPath.js"),a=require("./svgWriterUtils.js"),d=require("./matrix.js"),B=require("./utils.js"),w=require("./idGenerator.js"),k=require("./fontMaps.js"),l=require("./svgWriterUtils.js").rectToBounds,R={};function e(t,e){return e%2==1||t.split(" ").map(a.escapeCSS.bind(a)).join(" ")!=t&&(t='"'+t+'"'),t}function S(t){return t=(t=t.replace(/["']/g,"")).split(/(\s*,\s*)/).map(e).join("")}module.exports=new function(){this.externalizeStyles=function(t){var e,s,i,o,n,r=t.currentOMNode,a=t.svgOM.resources,l=k.weights,c=k.italics,f=Object.getOwnPropertyNames(l).join("|")+"|100|200|300|400|500|600|700|800|900",h=Object.getOwnPropertyNames(c).join("|");if(r.style&&r.style.ref&&a.styles&&a.styles[r.style.ref]&&B.merge(r.style,a.styles[r.style.ref]),r.style&&delete r.style.ref,e=JSON.stringify(r.style),R[e]&&(s=R[e],(o=a.styles[s])&&(r.className=s,n={style:o,type:r.type,shape:r.shape,className:s},t.omStylesheet.getStyleBlock(n),n.styleBlock.element=null,r.styleBlock=n.styleBlock)),delete t.stylesCurrentBlock,n&&(r=t.currentOMNode=n),M.externalizeStyles(t),v.externalizeStyles(t),C.externalizeStyles(t),O.externalizeStyles(t),N.externalizeStyles(t),i=t.omStylesheet.getStyleBlock(r),r.shape&&r.shape.winding&&i.addRule("fill-rule",r.shape.winding),r.style){if(r.style.font&&"object"==typeof r.style.font){var p=r.style.font,d="",u=p.style,y=p.family;if(isFinite(p.size)&&i.addRule("font-size",p.size+"px"),p.postscriptName&&(d+=p.postscriptName,u=function(t){var e=t&&t.match(/\-([^-]+)$/);if(e&&e[1])return e[1]}(p.postscriptName)||"normal"),y&&y!=p.postscriptName&&(d&&(d+=", "),d+=y=S(y)),d&&i.addRule("font-family",d),"small-caps"==p.variant&&i.addRule("font-variant",p.variant),u){var g=(u=u.toLowerCase().replace(/\s+/,"")).match(f),m=u.match(h);i.addRule("font-weight",l[g]||parseInt(g,10)||400),i.addRule("font-style",c[m]||"normal")}}if(r.style.textAttributes){if(r.style.textAttributes.decoration&&i.addRule("text-decoration",r.style.textAttributes.decoration.join(" ")),r.style.textAttributes.letterSpacing){var _=r.style.textAttributes.letterSpacing/1e3;_+=_?"em":0,i.addRule("letter-spacing",_)}"sideways-right"==r.style.textAttributes.glyphOrientation&&i.addRule("text-orientation","sideways-right")}Object.keys(r.style).forEach(function(t){void 0!==r.style[t]&&("fill"==t||"stroke"==t||"filters"==t||"meta"==t||"mask"==t||"clipPath"==t||"name"==t||"font"==t&&"object"==typeof r.style[t]||"textAttributes"==t||("font-size"!=t?"font-family"!=t?"blendMode"!=t?0!==t.indexOf("_")&&i.addRule(t,r.style[t]):i.addRule("mix-blend-mode",r.style[t]):i.addRule(t,S(r.style[t])):i.addRule(t,r.style[t]+"px")))})}};var c=function(t,e,s,i){var o,n,r;t._transformOnNode||("text"==e.type?function(t,e,s){var i=e.text,o=t._shiftContentX+(t._shiftCropRectX||0),n=t._shiftContentY+(t._shiftCropRectY||0);if(e.transform||i&&i.frame&&"path"==i.frame.type)return e.transform=e.transform||d.createMatrix(),e.transformTX=(e.transformTX||0)+t._shiftContentX,e.transformTY=(e.transformTY||0)+t._shiftContentY,e.children&&e.children.forEach(function(t){t._hasParentTXFM=!0});if(o||n){if(i){var r=i.frame;if(i.rawText,r&&(r.x=(r.x||0)+o,r.y=(r.y||0)+n),i.paragraphs&&i.paragraphs.length)for(var a=0;a<i.paragraphs.length;a++){var l=i.paragraphs[a];if(l.lines&&l.lines.length)for(var c=0;c<l.lines.length;c++){var f=l.lines[c];if(f&&f.length)for(var h=0;h<f.length;h++){var p=f[h];isFinite(p.x)&&(p.x+=o),isFinite(p.y)&&(p.y+=n)}}}}else e.position&&(s?("px"===e.position.unitX&&(e.position.x+=t._shiftContentX),"px"===e.position.unitY&&(e.position.y+=t._shiftContentY)):e.children&&1===e.children.length?(t.config.constrainToDocBounds&&"px"===e.position.unitX?e.position.x+=t._shiftContentX:e.position.x=0,"px"===e.position.unitY&&(e.position.y+=t._shiftContentY)):(t.config.constrainToDocBounds?e.position.x+=t._shiftContentX:e.position.x=0,e.position.y+=t._shiftContentY,t.eq(Math.abs(e.position.y),1)&&(e.position.y=1,e.position.unitY="em")));e.shifted=!0}}(t,e,s):"tspan"==e.type?(o=t,r=i,(n=e).style&&(n.position&&isFinite(n.position.x)&&(r&&!n._hasParentTXFM?n.position.x+=o._shiftContentX:n._parentIsRoot?"middle"!=n.style["text-anchor"]&&"end"!=n.style["text-anchor"]||n._hasParentTXFM?n.position.x=0:n.position.x-=n.visualBounds.x:n.position.x=void 0),"sub"!==n.style["_baseline-script"]&&"super"!==n.style["_baseline-script"]||("number"==typeof n.style["font-size"]?n.style["font-size"]=Math.round(n.style["font-size"]/2):n.style["font-size"].value=Math.round(n.style["font-size"].value/2)),"super"===n.style["_baseline-script"]&&(n.position=n.position||{},n.position.y=-.5,n.position.unitY="em"))):"shape"==e.type||"group"==e.type?function(t,e){var s,i=e.shape,o=t._shiftContentX+(t._shiftCropRectX||0),n=t._shiftContentY+(t._shiftCropRectY||0);if(e.visualBounds&&(s=l(e.visualBounds)),s&&(a.shiftBoundsX(s,o),a.shiftBoundsY(s,n)),e.transform&&!d.createMatrix(e.transform).isIdentity())return e.transformTX=t._shiftContentX,e.transformTY=t._shiftContentY,t._transformOnNode=!0;if(i)switch(i.type){case"circle":case"ellipse":i.cx+=o,i.cy+=n,e.shifted=!0;break;case"line":i.x1+=o,i.y1+=n,i.x2+=o,i.y2+=n,e.shifted=!0;break;case"compound":case"path":e.transformTX=o,e.transformTY=n;break;case"polygon":case"polyline":i.points.forEach(function(t){t.x+=o,t.y+=n}),e.shifted=!0;break;case"rect":i.x+=o,i.y+=n,e.shifted=!0}else e.shifted=!0}(t,e):"image"!=e.type&&"reference"!=e.type||function(t,e){var s=t._shiftContentX+(t._shiftCropRectX||0),i=t._shiftContentY+(t._shiftCropRectY||0);if(e.transform&&!d.createMatrix(e.transform).isIdentity())return e.transformTX=t._shiftContentX,e.transformTY=t._shiftContentY,t._transformOnNode=!0;var o=e.reference||e.image||e;o.x=(o.x||0)+s,o.y=(o.y||0)+i,e.shifted=!0}(t,e))},f=function(t,e){return e==t.svgOM||!e.hasOwnProperty("visible")||e.visible},x=function(e){var t=e.currentOMNode,s=(t.artboard||t.group||t).children;f(e,t)&&(e.config.trimToArtBounds&&function(t,e){var s,i=t.contentBounds,o=e.style&&e.style.stroke&&"none"!=e.style.stroke.type&&e.style.stroke.width||0,n=o?e.style.stroke.align:"center",r=0;if("inside"!=n||e.shape&&e.shape.type in{rect:1,ellipse:1,circle:1}?"outside"==n&&(r=-o/2):r=o/2,e.visualBounds&&(s=l(e.visualBounds)),"artboard"==e.type){var a=t.svgOM.artboards[(e.artboard||e).ref];s=l(a)}B.unionRect(i,s,r)}(e,t),s&&s.forEach(function(t){e.currentOMNode=t,x(e)}))};this.processSVGNode=function(i,o,n,e,t){var s=o.currentOMNode,r=(s.artboard||s.group||s).children,a=o._transformOnNode;if(s.id=i.getUnique(""),f(o,s)&&!s.processed){if(!o.tick||s.lines||s.to||o.nodeCounter++,"text"===s.type&&s.children&&s.children.forEach(function(t){t._parentBounds=s.textBounds,t._parentIsRoot=!e}),!o.config.trimToArtBounds||o.config.useViewBox||s===o.svgOM||n||c(o,s,e,t),s.processed=!0,s.style&&s.style.mask&&s.style.mask.ref&&o.svgOM.resources.masks&&(o.currentOMNode=o.svgOM.resources.masks[s.style.mask.ref],this.processSVGNode(i,o,n,e,t),o.currentOMNode=s),this.externalizeStyles(o),r&&r.forEach(function(t,e){o.currentOMNode=t,this.processSVGNode(i,o,n,s!==o.svgOM,e)},this),s.text&&s.text.paragraphs){var l=s.style||{};s.text.paragraphs.forEach(function(s,t){(o.currentOMNode=s).style=s.style||{},s.style.filters=s.style.filters||"",s.style.clipPath=s.style.clipPath||"",s.style.mask=s.style.mask||"",B.merge(s.style,l),this.processSVGNode(i,o,n,!0,t),s.lines&&s.lines.forEach(function(t){t.forEach(function(t,e){t.style=t.style||{},t.style.filters=t.style.filters||"",t.style.clipPath=t.style.clipPath||"",t.style.mask=t.style.mask||"",B.merge(t.style,s.style),o.currentOMNode=t,this.processSVGNode(i,o,n,!0,e)},this)},this)},this)}a!=o._transformOnNode&&(o._transformOnNode=!1)}},this.processSVGOM=function(e){var t,s,i,o,n,r,a,l,c,f,h,p=e.currentOMNode,d=this,u=e.svgOM.resources||{},y=e.config.cropRect,g=e.config.scale||1,m=new w;if(u.styles)for(var _ in u.styles)R[JSON.stringify(u.styles[_])]=_;e.omStylesheet=new b,e.config.trimToArtBounds?(x(e,e.currentOMNode),e.config.useViewBox?(e._x=e.contentBounds.left,e._y=e.contentBounds.top,e._width=e.contentBounds.right-e.contentBounds.left,e._height=e.contentBounds.bottom-e.contentBounds.top):(r=(i=e).contentBounds,a=i.docBounds,l=i.config.cropRect,c=i.config.artboardBounds,h=f=0,i._needsClipping=!(!i.config.clipToArtboardBounds||!c||B.containsRect(c,r)),i.config.isArtboard&&c&&(r={left:c.left,right:c.right,bottom:c.bottom,top:c.top}),i.config.constrainToDocBounds?(i._needsClipping=i._needsClipping||!B.containsRect(a,r),r.left=Math.max(0,r.left||0),r.right=Math.min(a.right,r.right||0),r.top=Math.max(0,r.top||0),r.bottom=Math.min(a.bottom,r.bottom||0)):(i._needsClipping=i._needsClipping||r.left<0||r.top<0,r.left=r.left||0,r.right=r.right||0,r.top=r.top||0,r.bottom=r.bottom||0),i._needsClipping=i._needsClipping&&!!l,i._shiftContentX=-r.left,i._shiftContentY=-r.top,i.config.clipToArtboardBounds&&c&&(f=Math.min(r.left-c.left,0),h=Math.min(r.top-c.top,0),r.left=Math.max(r.left,c.left),r.right=Math.min(r.right,c.right),r.top=Math.max(r.top,c.top),r.bottom=Math.min(r.bottom,c.bottom)),i._shiftContentX+=f,i._shiftContentY+=h,o=Math.abs(r.right-r.left),n=Math.abs(r.bottom-r.top),i._x=0,i._y=0,i._width=o,i._height=n,l&&(l.width/=i.config.scale||1,l.height/=i.config.scale||1,i.eq(l.width,o)&&i.eq(l.height,n)?i._needsClipping=!1:(i._width=l.width,i._height=l.height,i._shiftCropRectX=(l.width-o)/2,i._shiftCropRectY=(l.height-n)/2,i._needsClipping&&N.writeClipPath(i,[B.intersectRects(a,c)],i._shiftCropRectX,i._shiftCropRectY)))),e.currentOMNode=p):(e._x=e.docBounds.left,e._y=e.docBounds.top,e._width=e.docBounds.right-e.docBounds.left,e._height=e.docBounds.bottom-e.docBounds.top,y&&(t=e._width,s=e._height,y.width/=g,y.height/=g,e._width=y.width,e._height=y.height,e._x-=(y.width-t)/2,e._y-=(y.height-s)/2,(y.width>t||y.height>s)&&(e._needsClipping=!0,N.writeClipPath(e,[e.docBounds],0,0)))),e._viewBox=[e._x,e._y,e._width,e._height],e._width*=g,e._height*=g,Object.keys(u.masks||{}).forEach(function(t){e.currentOMNode=u.masks[t],d.processSVGNode(m,e,!0)}),Object.keys(u.clipPaths||{}).forEach(function(t){e.currentOMNode=u.clipPaths[t],d.processSVGNode(m,e,!0)}),Object.keys(u.patterns||{}).forEach(function(t){e.currentOMNode=u.patterns[t],d.processSVGNode(m,e,!0)}),Object.keys(u.symbols||{}).forEach(function(t){e.currentOMNode=u.symbols[t],d.processSVGNode(m,e,!0)}),e.currentOMNode=p,this.processSVGNode(m,e),e.currentOMNode=p}}}();