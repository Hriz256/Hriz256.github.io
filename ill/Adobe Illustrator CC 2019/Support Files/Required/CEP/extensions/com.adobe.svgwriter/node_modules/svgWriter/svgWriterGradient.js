!function(){"use strict";var v=require("./svgWriterUtils.js"),T=require("./utils.js"),S=require("./svgWriterTag.js"),F=v.round10k,O={},U=v.getTransform,M=0,b=0;function q(t,e){for(var r=[e[0]],n=1;n<e.length;n++)e[n-1].toString()!=e[n].toString()?r.push(e[n]):t.tagCounter--;return r}var C={gradientStopsReset:function(){O={}},getLinearGradientInternal:function(t,e,r,n,i,s,a){var o=U(r.transform,M,b,t.precision),f=r.x1+(o?0:M),c=r.x2+(o?0:M),d=r.y1+(o?0:b),u=r.y2+(o?0:b),y=r.units||"userSpaceOnUse",g={x1:f,y1:d,x2:c,y2:u,gradientTransform:o};i?(g["xlink:href"]="#"+i.id,i.gradientTransform&&!g.gradientTransform&&(g.gradientTransform="matrix(1, 0, 0, 1, 0, 0)"),n.setAttributes(g)):(O[s]={id:a,x1:f,y1:d,x2:c,y2:u,gradientTransform:o},g.gradientUnits=y,n.setAttributes(g),n.children=q(t,s))},getRadialGradientInternal:function(t,e,r,n,i,s,a){var o,f,c,d=U(r.transform,M,b,t.precision),u=r.cx+(d?0:M),y=r.cy+(d?0:b),g=r.fx?r.fx+(d?0:M):u,x=r.fy?r.fy+(d?0:b):y,l=r.r,p=r.units||"userSpaceOnUse",m={cx:u,cy:y,r:l,gradientTransform:d},h=.99*l;isFinite(g)&&!t.eq(g,u)&&(m.fx=g),isFinite(x)&&!t.eq(x,y)&&(m.fy=x),o=m.fx-m.cx,f=m.fy-m.fy,Math.sqrt(o*o+f*f)>h&&(c=Math.atan(f,o),o=Math.cos(c)*h,f=Math.sin(c)*h,m.fx=o+m.cx,m.fy=f+m.cy),i?(isFinite(i.fx)&&!isFinite(m.fx)&&isFinite(m.cx)&&(m.fx=m.cx),isFinite(i.fy)&&!isFinite(m.fy)&&isFinite(m.cy)&&(m.fy=m.cy),i.gradientTransform&&!m.gradientTransform&&(m.gradientTransform="matrix(1, 0, 0, 1, 0, 0)"),m["xlink:href"]="#"+i.id,n.setAttributes(m)):(O[s]={id:a,cx:u,cy:y,fx:m.fx,fy:m.fy,r:l,gradientTransform:d},m.gradientUnits=p,n.setAttributes(m),n.children=q(t,s))},writeGradient:function(e,r,t,n){var i=e.svgOM.resources.gradients[t.ref];if(i){var s,a,o,f,c=e.currentOMNode,d=i.name&&"Unnamed"!=i.name.substr(0,7)?i.name:void 0,u=e.ID.getUnique(i.type+"-gradient",d),y=i.stops,g=t.units||"userSpaceOnUse",x=[],l=0;e.currentOMNode=i;var p=new S(i.type+"Gradient",{id:u},e);if(e.currentOMNode=c,!e.minify&&d&&u!=d&&p.setAttribute("data-name",d),b=M=0,c.shifted&&"userSpaceOnUse"==g&&(M=(e._shiftContentX||0)+(e._shiftCropRectX||0),b=(e._shiftContentY||0)+(e._shiftCropRectY||0)),y){for(var m=0,h=y.length;m<h;++m)o=y[m],delete(s=T.clone(o.color)).alpha,l=isFinite(o.color.alpha)?o.color.alpha:1,x.push(new S("stop",{offset:o.offset,"stop-color":v.writeColor(s,e),"stop-opacity":l}));(f=O[x])&&(e.tagCounter-=x.length),"linear"==i.type?C.getLinearGradientInternal(e,i,t,p,f,x,u):C.getRadialGradientInternal(e,i,t,p,f,x,u),a=JSON.stringify({cx:F(t.cx),cy:F(t.cy),x1:F(t.x1),y1:F(t.y1),x2:F(t.x2),y2:F(t.y2),fx:F(t.fx),fy:F(t.fy),r:F(t.r),transform:t.transform,stops:y,gradientSpace:g}),e.omStylesheet.def(p,function(t){r.addRule(n,"url(#"+e.prefix+t.getAttribute("id")+")")},a)}else console.warn("encountered gradient with no stops")}else e.errors.push("Gradient "+t.ref+" is missing.")}};module.exports=C}();