!function(){"use strict";var t,n=require("./svgWriterUtils.js"),c=require("./svgWriterTag.js"),l=require("./svgWriterGradient.js"),a=require("./svgWriterContext.js"),u=n.writeln,h=n.indent,o=n.undent;function f(t){t&&t.splice?this.class=t:this.class=[].slice.call(arguments,0),this.rules={},this.defs={},this.tags=[]}function e(){this.defines={},this.eleDefines={},this.blocks={}}(t=f.prototype).addRule=function(t,e){var s=c.getDefault("*",t),r=c.getValue("*",t,e,{precision:3});this.defs[t]=r+""==s+"",this.rules[t]=e},t.enforceRule=function(t){this.rules[t+"!"]=this.rules[t],this.defs[t+"!"]=!1,delete this.defs[t],delete this.rules[t]},t.removeRule=function(t,e){null!=e&&this.rules[t]!=e||delete this.rules[t]},t.hasRules=function(){var t=0;for(var e in this.rules)t+=!this.defs[e];return!!t},t.write=t.toString=function(t){var e;for(var s in t=t||new a({}),u(t,t.currentIndent+"."+this.class.map((e=t,function(t){return e.prefix+n.escapeCSS(t)})).join(","+t.space+".")+t.space+"{"),h(t),this.rules){var r=this.rules[s];if("!"==s.charAt(s.length-1)&&(s=s.substring(0,s.length-1)),!this.defs[s]){var i=c.getValue("*",s,r,t);u(t,t.currentIndent+s+":"+t.space+i+";")}}return o(t),u(t,t.currentIndent+"}"),t.sOut},t.hasProperty=function(t){return t in this.rules},t.getPropertyValue=function(t){return this.rules[t]},t.isEqual=function(t){if(!t)return!1;for(var e in this.rules)if(t.rules[e]!=this.rules[e])return!1;for(e in t.rules)if(t.rules[e]!=this.rules[e])return!1;return!0},function(t){t.hasDefines=function(){return!!this.defs&&!!Object.keys(this.defs).length},t.def=function(t,e,s){if(this.defs=this.defs||{},null==s){var r=t.getAttribute("id"),i=t.getAttribute("data-name");t.setAttributes({id:"","data-name":""}),s=t.toString(),t.setAttributes({id:r,"data-name":i})}this.defs[s]?(e&&this.defs[s].as.push(e),t.ctx&&(t.ctx.tagCounter-=function t(e){var s=1;if(!e.chidren||!e.children.length)return s;for(var r=0;r<e.children.length;r++)s+=t(e.children[r]);return s}(t))):this.defs[s]={tag:t,as:e?[e]:[]}},t.getDefsTag=function(){var t,e,r=this,s=new c("defs");if(s.children.push(this.getStyleTag()),l.gradientStopsReset(),this.defs)for(t in this.defs){e=this.defs[t],s.children.push(e.tag);for(var i=0;i<e.as.length;i++)e.as[i](e.tag)}var n=s.write;return s.write=s.toString=function(t){var e=!t.styling&&r.hasRules(),s=r.hasDefines();return e||s?n.call(this,t):""},s},t.hasRules=function(){for(var t in this.blocks)if(this.blocks[t]&&this.blocks[t].hasRules())return!0;return!1};var e=1;t.getStyleBlock=function(t){return t.className=t.className||"cls-"+e++,this.blocks[t.className]?t.styleBlock=this.blocks[t.className]:t.styleBlock=t.styleBlock||new f(t.className),this.blocks[t.className]=t.styleBlock,t.styleBlock},t.consolidateStyleBlocks=function(){var t,e,s,r,i,n,l,a={};for(t in this.blocks)if(this.blocks.hasOwnProperty(t)){if(!(e=this.blocks[t]).hasRules()){delete this.blocks[t];continue}i=JSON.stringify(e.rules),a[e.fingerprint=i]=a[i]||[],a[i].push(e)}for(i in a)if(a.hasOwnProperty(i)&&(r=a[i])&&r.length)for(s=1;s<r.length;s++){l=r[s].tags;for(var u=0;l&&u<l.length;u++)(n=c.getById(l[u]))&&(delete this.blocks[n.styleBlock.class],n.styleBlock=r[0],r[0].tags.push(l[u]));r[0].consolidated=!0}},t.getStyleTag=function(){var t=new c("style");return t.write=t.toString=this.writeSheet.bind(this),t},t.writeSheet=function(t){if(t.styling)return"";var e,s=[];for(e in this.blocks)this.blocks.hasOwnProperty(e)&&this.blocks[e].hasRules()&&this.blocks[e].tags&&this.blocks[e].tags.length&&s.push(this.blocks[e]);var r=0,i=s.length;if(!i)return"";for(u(t,t.currentIndent+"<style>"),h(t),i=(s=this.extract(s)).length;r<i;r++)r&&u(t),s[r].write(t);o(t),u(t,t.currentIndent+"</style>"),t.tick&&t.tick("write")},t.extract=function(t){var e,s,r,i,n,l={},a={};for(n=0;n<t.length;n++)for(var u in s=t[n].class,t[n].rules)if(!t[n].defs[u]){var c=t[n].rules[u];l[i=u+":"+c]=l[i]||{name:u,value:c,classes:[]},l[i].classes=l[i].classes.concat(s)}for(i in t=[],l){var h=(r=l[i]).classes.sort();a[h]?a[h].addRule(r.name,r.value):((e=new f(h)).addRule(r.name,r.value),t.push(e),a[h]=e)}return t}}(e.prototype),module.exports=e}();