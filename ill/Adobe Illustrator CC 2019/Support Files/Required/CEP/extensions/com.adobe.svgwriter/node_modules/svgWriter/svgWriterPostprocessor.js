!function(){"use strict";var u,d=require("./svgWriterTag.js"),h=require("./idGenerator.js"),c=require("./matrix.js"),f=require("./svgWriterUtils.js").getTransform,y=function(e,t){var r,l,i;for(i=0;i<t.length-1;i++)for(r=!1;t[i+1]&&t[i].styleBlock&&t[i+1].styleBlock&&t[i].styleBlock.isEqual(t[i+1].styleBlock);){for(l in t[i].attrs)if(t[i].writeAttribute(l)){r=!0;break}if(r)break;for(l in t[i+1].attrs)if(t[i+1].writeAttribute(l)){r=!0;break}if(r)break;t[i].children=t[i].children.concat(t[i+1].children),y(e,t[i].children),t.splice(i+1,1),u--}},g=[function(e,t,r,l){var i,n=r[r.length-1],s=!1;if(n&&"g"==e.name&&!e.isArtboard)if(e.children.length){if(i=1==n.children.length&&("pattern"==n.name||"symbol"==n.name||"mask"==n.name),"svg"==n.name){s=!0;for(var o=0;o<n.children.length;o++)if(o!=l&&n.children[o].name&&"defs"!=n.children[o].name&&"title"!=n.children[o].name&&"#comment"!=n.children[o].name&&"desc"!=n.children[o].name){s=!1;break}}var a,c,f;if(!function(e,t){if(t.custom)return!0;var r=t.styleBlock;return!!r&&(r.hasProperty("mix-blend-mode")&&"normal"!=r.getPropertyValue("mix-blend-mode")||r.hasProperty("isolation")||r.hasProperty("clip-path")&&"none"!=r.getPropertyValue("clip-path")||r.hasProperty("filter")&&"none"!=r.getPropertyValue("filter")||r.hasProperty("mask")&&"none"!=r.getPropertyValue("mask")||r.hasProperty("opacity")&&!e.eq(r.getPropertyValue("opacity"),1))}(t,e)&&""==e.getAttribute("transform")&&""==e.getAttribute("clip-path")&&(""==e.getAttribute("id")||s))if(!(1<e.children.length)||t.minify||i||s)s&&(n.setAttribute("id",e.getAttribute("id")),n.setAttribute("data-name",e.getAttribute("data-name"))),n.children.splice(l,1),a=n.children,c=l,f=e.children,Array.prototype.splice.apply(a,[c,0].concat(f)),u--}else n.children.splice(l,1)},function(e,t,r){var l=e.styleBlock&&e.styleBlock.getPropertyValue("fill-rule");if(l){for(var i,n=0,s=r.length;n<s;n++)if("clipPath"==r[n].name){i=!0;break}i&&(e.styleBlock.addRule("clip-rule",l),e.styleBlock.removeRule("fill-rule"))}},function(e,t){if("mask"==e.name&&e.filter)if(e.setAttribute("style",""),1==e.children.length&&""==e.children[0].getAttribute("transform"))e.children[0].styleBlock||e.children[0].setStyleBlock(t,{}),e.children[0].styleBlock.addRule("filter","url(#"+t.prefix+e.filter+")");else{var r=new d("g");r.setStyleBlock(t,{}),r.styleBlock.addRule("filter","url(#"+t.prefix+e.filter+")"),r.children=e.children,e.children=[r]}},function(i,e,n){"tspan"==i.name&&Object.keys(i.styleBlock.rules).forEach(function(e){if(i.styleBlock.rules[e]&&i.styleBlock.defs[e]){for(var t,r=n.length;r--;){var l=n[r].styleBlock;if(l&&(l.rules[e]&&!l.defs[e]||l.rules[e+"!"]&&!l.defs[e+"!"])){t=!0;break}}t&&i.styleBlock.enforceRule(e)}})},function(e,t){if("tspan"==e.name||"text"==e.name){for(var r,l=e.styleBlock,i={},n=0;n<e.children.length;n++){var s=e.children[n].styleBlock;if(!s)return;if(n)for(r in i)null==s.getPropertyValue(r)&&delete i[r];else for(r in s.rules)i[r]=s.rules[r]}var o=[];for(n=0;n<e.children.length;n++){var a=e.children[n];if(s=a.styleBlock){for(r in s.rules)i[r]==s.rules[r]?(delete s.rules[r],delete s.defs[r]):s.defs[r]&&s.enforceRule(r);var c=a.styleBlock.hasRules();if(!c)for(r in a.attrs)if(a.writeAttribute(r)){c=!0;break}c||o.push(a)}}for(u-=o.length,n=0;n<o.length;n++)e.collapseChild(o[n]);for(r in y(t,e.children),i)l.addRule(r,i[r]);"text"==e.name&&("normal"==l.rules["font-style"]&&l.removeRule("font-style"),400==l.rules["font-weight"]&&l.removeRule("font-weight"))}},function(e,t,r){if(e.globalFilter){var l,i,n=r[r.length-1],s=c.createMatrix(),o=e.getAttribute("filter");if(r.forEach(function(e){e.transform&&s.preMultiplyBy(c.createMatrix(e.transform))}),l=s.inverse()){(i=new d("g",{transform:f(l)})).setStyleBlock(t,{}),i.styleBlock.addRule("filter",o),i.appendChild(e),s.preMultiplyBy(c.createMatrix(e.transform)),e.styleBlock.removeRule("filter"),e.setAttribute("transform",f(s));for(var a=0;a<n.children.length;a++)if(n.children[a]==e){n.children[a]=i;break}}}},function(e,t,r){if(e.trick){var l=r[r.length-1],i=e.getAttribute("stroke"),n=e.getAttribute("fill"),s=e.getAttribute("filter"),o=e.getAttribute("transform"),a=e.getAttribute("id")||t.ID.getUnique(e.name),c=new d,f=new d("g",{transform:o}),u=new d("use",{"xlink:href":"#"+a,transform:o});t.xlinkRequired=!0,e.setAttribute("id",a),c.appendChild(f,u),f.appendChild(e),e.setAttribute("transform",null),t.styling?(f.setAttributes({fill:n,filter:s}),e.setAttributes({stroke:"inherit",filter:"none",fill:"inherit"}),u.setAttributes({stroke:i,fill:"none",filter:"none"})):(f.setAttribute("style","fill: "+n+"; filter: "+s),e.setAttribute("style","stroke: inherit; filter: none; fill: inherit"),u.setAttribute("style","stroke: "+i+"; filter: none; fill: none"));for(var h=0;h<l.children.length;h++)if(l.children[h]==e){l.children[h]=c;break}}}];module.exports.postProcess=function e(t,r,l,i){var n,s,o,a,c=!l;if(c&&(u=0),(l=l||[]).push(t),t.children)for(var f=t.children.length-1;0<=f;f--)e(t.children[f],r,l.slice(0),f);l.pop(),n=t,s=r,o=l.slice(0),a=i,s.tick&&s.tick("post"),g.forEach(function(e){e(n,s,o,a)}),c&&(r.omStylesheet.consolidateStyleBlocks(),function(e,t){var r=new h(e.idType);for(var l in t)!(t[l].tags&&t[l].tags.length&&t[l].hasRules())||e.svgOM.resources.styles&&e.svgOM.resources.styles[t[l].class[0]]||(t[l].class[0]=r.getUnique("cls"))}(r,r.omStylesheet.blocks),r.tick&&(r.tagCounter+=u))}}();